import os
import time
import telebot
from openai import OpenAI

# --- –ö–õ–Æ–ß–ò –ò–ó –°–ï–ö–†–ï–¢–û–í ---
GROQ_API_KEY = os.environ.get("GROQ_API_KEY")
TG_BOT_TOKEN = os.environ.get("TG_BOT_TOKEN")

# --- ID –ö–ê–ù–ê–õ–ê (–ö–ê–ö –í –¢–í–û–ï–ú –ö–û–î–ï, –ü–†–û–ü–ò–°–´–í–ê–ï–ú –ü–†–Ø–ú–û –ó–î–ï–°–¨) ---
# ‚ùóÔ∏è –í–ê–ñ–ù–û: –í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–≤–æ–π ID –∫–∞–Ω–∞–ª–∞ —Å –º–∏–Ω—É—Å–æ–º
CHANNEL_ID = "@loldose777" 

# --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø (–ö–ê–ö –í –¢–í–û–ï–ú –ö–û–î–ï) ---
client = OpenAI(api_key=GROQ_API_KEY, base_url="https://api.groq.com/openai/v1")
bot = telebot.TeleBot(TG_BOT_TOKEN)

# --- –†–ê–ë–û–ß–ê–Ø –ú–û–î–ï–õ–¨ (–ù–ê–ô–î–ï–ù–ê –¢–û–ë–û–ô) ---
MODEL = "llama3-1.1-70b-versatile"

def generate_joke():
    # –ù–∞—à "–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π" –ø—Ä–æ–º–ø—Ç —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    sys_prompt = (
        "–¢—ã ‚Äî —Ç–æ–ø–æ–≤—ã–π –∞–≤—Ç–æ—Ä —Ä–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–≥–æ Telegram-–∫–∞–Ω–∞–ª–∞. \n"
        "–ó–∞–¥–∞—á–∞: –ù–∞–ø–∏—Å–∞—Ç—å –ê–ù–ï–ö–î–û–¢, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—á–µ—Ç—Å—è –¥–æ—á–∏—Ç–∞—Ç—å –¥–æ –∫–æ–Ω—Ü–∞. \n"
        "–°—Ç–∏–ª—å: –ñ–∏–≤–æ–π, –¥–µ—Ä–∑–∫–∏–π, –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∞—Ç. \n"
        "\n"
        "‚õîÔ∏è –°–¢–†–û–ì–ò–ï –ó–ê–ü–†–ï–¢–´ (–¢–ê–ë–£):\n"
        "1. –ù–ò–ö–ê–ö–û–ô –ü–û–õ–ò–¢–ò–ö–ò, –í–õ–ê–°–¢–ò, –ü–†–ï–ó–ò–î–ï–ù–¢–û–í.\n"
        "2. –ù–ï –¢–†–û–ì–ê–¢–¨ –ê–†–ú–ò–Æ, –°–í–û, –í–ï–¢–ï–†–ê–ù–û–í.\n"
        "3. –ù–ï –¢–†–û–ì–ê–¢–¨ –†–ï–õ–ò–ì–ò–Æ –ò –¶–ï–†–ö–û–í–¨.\n"
        "4. –ë–ï–ó –û–°–ö–û–†–ë–õ–ï–ù–ò–ô –ù–ê–¶–ò–ô.\n"
        "5. –ù–ï –ó–ê–¢–†–ê–ì–ò–í–ê–ô –¢–ï–ú–´, –ó–ê–ü–†–ï–©–ï–ù–ù–´–ï –ó–ê–ö–û–ù–ê–ú–ò –†–û–°–°–ò–ò.\n"
        "–®—É—Ç–∏ –ø—Ä–æ –≤—Å—ë, –∫—Ä–æ–º–µ —Ç–∞–±—É–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ–º.\n"
        "\n"
        "–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (HTML):\n"
        "1. <b>–ö–ª–∏–∫–±–µ–π—Ç–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–¥–æ 70 –∑–Ω–∞–∫–æ–≤)</b>\n"
        "2. –¢–µ–∫—Å—Ç –∞–Ω–µ–∫–¥–æ—Ç–∞ (—Å —ç–º–æ–¥–∑–∏ üåöüî•).\n"
        "3. <tg-spoiler>–ü–∞–Ω—á–ª–∞–π–Ω (—Ä–∞–∑–≤—è–∑–∫–∞)</tg-spoiler>\n"
        "4. –¢—Ä–∏ —Ö–µ—à—Ç–µ–≥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä #—é–º–æ—Ä #–∂–∏–∑–∞)."
    )
    user_prompt = "–†–∞—Å—Å–∫–∞–∂–∏ —Å–≤–µ–∂–∏–π, —É–±–æ–π–Ω—ã–π –∞–Ω–µ–∫–¥–æ—Ç."

    try:
        print(f"–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –≤ Groq (–º–æ–¥–µ–ª—å: {MODEL})...")
        response = client.chat.completions.create(
            model=MODEL,
            messages=[{"role": "system", "content": sys_prompt}, {"role": "user", "content": user_prompt}],
            temperature=1.1,
            timeout=40.0
        )
        print("–ü–æ–ª—É—á–∏–ª –æ—Ç–≤–µ—Ç –æ—Ç Groq.")
        return response.choices[0].message.content
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Groq: {e}")
        return None

if __name__ == "__main__":
    jokes_generated = 0
    for i in range(2):
        print(f"--- –ê–Ω–µ–∫–¥–æ—Ç ‚Ññ{i+1} ---")
        joke_text = generate_joke()
        if joke_text:
            try:
                print("–û—Ç–ø—Ä–∞–≤–ª—è—é –≤ –¢–µ–ª–µ–≥—Ä–∞–º...")
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π –º–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏, –Ω–æ —Å HTML
                bot.send_message(CHANNEL_ID, joke_text, parse_mode="HTML")
                print("‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.")
                jokes_generated += 1
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –¢–µ–ª–µ–≥—Ä–∞–º: {e}")
        else:
            print("‚ùå –ú–æ–¥–µ–ª—å –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∞ –∞–Ω–µ–∫–¥–æ—Ç.")
        
        if i == 0:
            time.sleep(5)
    
    # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏, –∑–∞–≤–µ—Ä—à–∞–µ–º —Å –æ—à–∏–±–∫–æ–π –¥–ª—è GitHub Actions
    if jokes_generated == 0:
        print("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–∏ –æ–¥–Ω–æ–≥–æ –∞–Ω–µ–∫–¥–æ—Ç–∞ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ.")
        exit(1)
